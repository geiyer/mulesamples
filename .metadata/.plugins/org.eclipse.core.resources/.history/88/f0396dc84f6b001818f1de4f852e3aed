<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:file="http://www.mulesoft.org/schema/mule/file"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="f92903e7-982a-4a42-b341-1af00240d1ec" >
		<http:listener-connection host="localhost" port="8081" />
	</http:listener-config>
	<file:config name="File_Config" doc:name="File Config" doc:id="6870e1ab-7cd8-41ae-acf2-befcba4caba2" />
	<flow name="mergetwojsonFlow" doc:id="b6f5203a-98ea-46c4-b9de-7ac8a24082cb" >
		<http:listener doc:name="Listener" doc:id="c6b763c5-8eed-421b-a9b9-e60e28d97694" config-ref="HTTP_Listener_config" path="/merge"/>
		<file:read doc:name="Read PayLoad 1" doc:id="a1759953-f255-4964-9abc-875b08e6d6c0" config-ref="File_Config" path="C:\Users\E71849\Documents\Learning\mulesoft\AnyPointStudio\4.0\workspace\mulesamples\mergetwojson\src\main\resources\payload1.JSON"/>
		<set-variable value="#[payload]" doc:name="Set Variable" doc:id="1733d149-0b16-4f1c-b0ea-b2ffb45d7aa4" variableName="payload1" mimeType="application/json"/>
		<logger level="INFO" doc:name="Logger" doc:id="976cb66d-1bb5-4a8a-a729-304d3b825ca5" message="#[vars.payload1]"/>
		<file:read doc:name="Read Payload 2" doc:id="bfbf46e7-2cc6-4e98-abac-cc411bca307f" path="C:\Users\E71849\Documents\Learning\mulesoft\AnyPointStudio\4.0\workspace\mulesamples\mergetwojson\src\main\resources\payload2.JSON" config-ref="File_Config"/>
		<ee:transform doc:name="Transform Message" doc:id="b388220d-42df-4226-bd68-526d9c70eed2" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
{
correspondence: payload map ((payload1 , indexOfPayload1) -> {
"eventId": payload1.eventId,
Investment: payload1.Investment,
(flowVars.variable2.Workforce filter ($."Service line number" == payload1."Service line number")  map ((variable2 , indexOfVariable2) -> {
Employees: variable2.Employees
})),
(flowVars.variable1.Result filter ($."Service line number" == payload1."Service line number")  map ((variable1 , indexOfVariable1) -> {
Profit: variable1.Profit
}))
})
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<ee:transform doc:name="Transform Message" doc:id="9025f140-e196-4dd6-b7a8-35ff38f0f16e" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/xml
---
{
	root: {
		correspondence: {
			eventid: payload.eventid as Number default 0,
			name: payload.name default "",
			address: payload.address default "",
			payload map(events) -> using(id = events.eventid){
				(variables.payload1 filter ($.*eventid contains id) map(eventtype) -> {
					eventtype:	eventtype.eventtype
				})
				
				
			}
		}
	}
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="1c4d42d5-1cf2-428b-b6e5-db1f62d17035" message="#[payload]"/>
	</flow>
</mule>
